// Lark grammar for Snowflake SQL
%import common.CNAME -> IDENTIFIER
%import common.SIGNED_NUMBER
%import common.INT -> UNSIGNED_INTEGER
%import common.ESCAPED_STRING
%import common.WS
%ignore WS

// Define all terminals (keywords) as uppercase
SELECT: "SELECT"i
FROM: "FROM"i
WHERE: "WHERE"i
GROUP: "GROUP"i
BY: "BY"i
HAVING: "HAVING"i
ORDER: "ORDER"i
LIMIT: "LIMIT"i
WITH: "WITH"i
AS: "AS"i
AND: "AND"i
OR: "OR"i
NOT: "NOT"i
NULL: "NULL"i
TRUE: "TRUE"i
FALSE: "FALSE"i
INSERT: "INSERT"i
INTO: "INTO"i
VALUES: "VALUES"i
UPDATE: "UPDATE"i
SET: "SET"i
DELETE: "DELETE"i
LIKE: "LIKE"i
IN: "IN"i
IS: "IS"i
JOIN: "JOIN"i
ON: "ON"i
USING: "USING"i
USE: "USE"i
IF: "IF"i
EXISTS: "EXISTS"i

// DDL Commands
CREATE: "CREATE"i
ALTER: "ALTER"i
DROP: "DROP"i
TRUNCATE: "TRUNCATE"i
SHOW: "SHOW"i
DESC: "DESC"i
DESCRIBE: "DESCRIBE"i
COMMENT: "COMMENT"i
REPLACE: "REPLACE"i

// Object types
TABLE: "TABLE"i
VIEW: "VIEW"i
DATABASE: "DATABASE"i
SCHEMA: "SCHEMA"i
WAREHOUSE: "WAREHOUSE"i
TASK: "TASK"i 
STREAM: "STREAM"i
STAGE: "STAGE"i
PROCEDURE: "PROCEDURE"i
FUNCTION: "FUNCTION"i
SEQUENCE: "SEQUENCE"i
MATERIALIZED: "MATERIALIZED"i

// Column constraints
PRIMARY: "PRIMARY"i
KEY: "KEY"i
FOREIGN: "FOREIGN"i
REFERENCES: "REFERENCES"i
UNIQUE: "UNIQUE"i
DEFAULT: "DEFAULT"i
COLUMN: "COLUMN"i
ADD: "ADD"i
MODIFY: "MODIFY"i

// Snowflake specific
WAREHOUSE_SIZE: "WAREHOUSE_SIZE"i
AUTO_SUSPEND: "AUTO_SUSPEND"i
AUTO_RESUME: "AUTO_RESUME"i
INITIALLY_SUSPENDED: "INITIALLY_SUSPENDED"i
SCHEDULE: "SCHEDULE"i
SUSPEND: "SUSPEND"i
RESUME: "RESUME"i
APPEND_ONLY: "APPEND_ONLY"i
SHOW_INITIAL_ROWS: "SHOW_INITIAL_ROWS"i
FILE_FORMAT: "FILE_FORMAT"i
URL: "URL"i
RETURNS: "RETURNS"i
LANGUAGE: "LANGUAGE"i
AFTER: "AFTER"i

SEMICOLON: ";" // Define semicolon as a terminal

// Define a terminal for single-quoted strings, handling escaped single quotes
SINGLE_QUOTED_STRING: /'([^\'\\]|\\.)*'/

// Common Rules
qualified_name: IDENTIFIER ( "." IDENTIFIER )*

// Start rule - Use the SEMICOLON terminal
start: (_statement SEMICOLON? )*
_statement: statement // Alias to avoid left-recursion issues if statement calls start indirectly

statement: select_stmt
         | dml_stmt
         | ddl_stmt
         | use_stmt

// DML Statements
dml_stmt: insert_stmt
        | update_stmt
        | delete_stmt

// DDL Statements
ddl_stmt: create_stmt
        | alter_stmt
        | drop_stmt
        | truncate_stmt 
        | show_stmt
        | describe_stmt

// SELECT statement
select_stmt: SELECT select_list from_clause? where_clause? group_clause? having_clause? order_clause? limit_clause?
select_list: "*" | select_item ("," select_item)*
select_item: expr (AS? IDENTIFIER)?
from_clause: FROM table_ref ("," table_ref)*
table_ref: qualified_name (AS? IDENTIFIER)?
         | "(" select_stmt ")" (AS? IDENTIFIER)?
         | table_ref join_type? JOIN table_ref (ON expr | USING "(" qualified_name ("," qualified_name)* ")")?
join_type: "INNER"i | "LEFT"i | "RIGHT"i | "FULL"i | "CROSS"i
where_clause: WHERE expr
group_clause: GROUP BY expr ("," expr)*
having_clause: HAVING expr
order_clause: ORDER BY order_item ("," order_item)*
order_item: expr ("ASC"i | "DESC"i)?
limit_clause: LIMIT UNSIGNED_INTEGER

// INSERT statement
insert_stmt: INSERT INTO qualified_name ("(" qualified_name ("," qualified_name)* ")")? VALUES "(" expr ("," expr)* ")"
           | INSERT INTO qualified_name ("(" qualified_name ("," qualified_name)* ")")? select_stmt

// UPDATE statement
update_stmt: UPDATE qualified_name SET qualified_name "=" expr ("," qualified_name "=" expr)* where_clause?

// DELETE statement
delete_stmt: DELETE FROM qualified_name where_clause?

// CREATE statements
create_stmt: create_table_stmt
           | create_view_stmt
           | create_warehouse_stmt
           | create_task_stmt
           | create_stream_stmt
           | create_stage_stmt
           | create_database_stmt
           | create_schema_stmt

create_table_stmt: CREATE (OR REPLACE)? TABLE qualified_name ("(" column_def ("," column_def)* ")")?
column_def: qualified_name data_type (column_constraint)*
data_type: IDENTIFIER ("(" UNSIGNED_INTEGER ("," UNSIGNED_INTEGER)? ")")?
column_constraint: NOT NULL | NULL | PRIMARY KEY | UNIQUE | DEFAULT expr | REFERENCES qualified_name

create_view_stmt: CREATE (OR REPLACE)? VIEW qualified_name AS select_stmt

create_warehouse_stmt: CREATE (OR REPLACE)? WAREHOUSE (IF NOT EXISTS)? qualified_name warehouse_param*
warehouse_param: WAREHOUSE_SIZE "=" (IDENTIFIER | string)
               | AUTO_SUSPEND "=" UNSIGNED_INTEGER
               | AUTO_RESUME "=" boolean
               | INITIALLY_SUSPENDED "=" boolean

create_task_stmt: CREATE (OR REPLACE)? TASK qualified_name task_param* AS _statement
task_param: WAREHOUSE "=" qualified_name
          | SCHEDULE "=" string
          | AFTER "=" qualified_name

create_stream_stmt: CREATE (OR REPLACE)? STREAM qualified_name ON (TABLE | STAGE) qualified_name stream_param*
stream_param: APPEND_ONLY "=" boolean
            | SHOW_INITIAL_ROWS "=" boolean

create_stage_stmt: CREATE (OR REPLACE)? STAGE qualified_name stage_param*
stage_param: URL "=" string
           | FILE_FORMAT "=" (qualified_name | "(" file_format_option+ ")")

// Helper rule for file format options within parentheses
file_format_option: IDENTIFIER "=" (string | IDENTIFIER | boolean | number)

create_database_stmt: CREATE (OR REPLACE)? DATABASE (IF NOT EXISTS)? qualified_name

create_schema_stmt: CREATE (OR REPLACE)? SCHEMA qualified_name

// ALTER statements
alter_stmt: alter_table_stmt
          | alter_warehouse_stmt
          | alter_task_stmt
          | alter_stream_stmt

alter_table_stmt: ALTER TABLE qualified_name alter_table_action
alter_table_action: ADD COLUMN qualified_name data_type
                  | DROP COLUMN qualified_name
                  | MODIFY COLUMN qualified_name data_type

alter_warehouse_stmt: ALTER WAREHOUSE qualified_name alter_warehouse_action
alter_warehouse_action: SET warehouse_set_item+  // Allow one or more items
                      | SUSPEND
                      | RESUME

// Helper rule for SET items in ALTER WAREHOUSE
warehouse_set_item: warehouse_param_key "=" warehouse_param_value

// Define keys and value types allowed in SET
warehouse_param_key: WAREHOUSE_SIZE | AUTO_SUSPEND | AUTO_RESUME | INITIALLY_SUSPENDED
warehouse_param_value: IDENTIFIER | string | UNSIGNED_INTEGER | boolean

alter_task_stmt: ALTER TASK qualified_name alter_task_action
alter_task_action: SET WAREHOUSE "=" qualified_name
                 | SET SCHEDULE "=" string
                 | SUSPEND
                 | RESUME

alter_stream_stmt: ALTER STREAM qualified_name SET APPEND_ONLY "=" boolean

// DROP statements
drop_stmt: DROP object_type qualified_name
object_type: TABLE | VIEW | WAREHOUSE | TASK | STREAM | STAGE | DATABASE | SCHEMA | PROCEDURE | FUNCTION | SEQUENCE

// TRUNCATE statement
truncate_stmt: TRUNCATE TABLE qualified_name

// SHOW statement
show_stmt: SHOW object_types
object_types: "TABLES"i | "VIEWS"i | "WAREHOUSES"i | "TASKS"i | "STREAMS"i | "STAGES"i | "DATABASES"i | "SCHEMAS"i

// DESCRIBE statement
describe_stmt: (DESCRIBE | DESC) object_type qualified_name

// USE statement (Example for WAREHOUSE)
use_stmt: USE object_type qualified_name

// Expressions
expr: literal
    | qualified_name
    | function_call
    | "(" expr ")"
    | expr binary_op expr
    | unary_op expr
    | expr LIKE string
    | expr IN "(" expr ("," expr)* ")"
    | expr IS NULL
    | expr IS NOT NULL

// Function calls
function_call: qualified_name "(" (expr ("," expr)*)? ")"

// Operators
binary_op: "+" | "-" | "*" | "/" | "=" | "!=" | "<>" | "<" | ">" | "<=" | ">=" | AND | OR
unary_op: NOT | "+" | "-"

// Literals
literal: string
       | number 
       | boolean
       | NULL

// Redefine 'string' rule to use our single-quoted terminal
string: SINGLE_QUOTED_STRING 
number: SIGNED_NUMBER
boolean: TRUE | FALSE
